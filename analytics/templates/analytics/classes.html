{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Class Analytics" %} - AIMS EXAM{% endblock %}

{% block content %}
<div class="topbar">
    <div class="topbar-left">
        <h1 class="topbar-title">{% trans "Class Analytics" %}</h1>
        {% if schools %}
        <div style="margin-left: 20px;">
            <select onchange="window.location.href='?school_id='+this.value+'&source={{ source }}'" class="form-select"
                style="min-width: 200px;">
                {% for s in schools %}
                <option value="{{ s.pk }}" {% if s.pk == school.pk %}selected{% endif %}>{{ s.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div style="margin-left: 20px; display: flex; gap: 4px;">
            <a href="?{% if school %}school_id={{ school.pk }}&{% endif %}source=exams"
                class="btn btn-sm {% if source == 'exams' or not source %}btn-primary{% else %}btn-outline{% endif %}">
                {% trans "Exams" %}
            </a>
            <a href="?{% if school %}school_id={{ school.pk }}&{% endif %}source=zipgrade"
                class="btn btn-sm {% if source == 'zipgrade' %}btn-primary{% else %}btn-outline{% endif %}">
                {% trans "ZipGrade" %}
            </a>
        </div>
    </div>
    <div class="topbar-actions">
        <a href="{% url 'analytics:class_heatmap' %}{% if school %}?school_id={{ school.pk }}{% endif %}"
            class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <rect x="7" y="7" width="3" height="3" />
                <rect x="14" y="7" width="3" height="3" />
                <rect x="7" y="14" width="3" height="3" />
                <rect x="14" y="14" width="3" height="3" />
            </svg>
            {% trans "Topic Heatmap" %}
        </a>
        <a href="{% url 'analytics:export_class_excel' %}?grade={{ selected_class.grade }}&section={{ selected_class.section }}{% if school %}&school_id={{ school.pk }}{% endif %}"
            class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            {% trans "Excel" %}
        </a>
        <a href="{% url 'analytics:export_class_pdf' %}?grade={{ selected_class.grade }}&section={{ selected_class.section }}{% if school %}&school_id={{ school.pk }}{% endif %}"
            class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            {% trans "PDF" %}
        </a>
    </div>
</div>

{% include 'partials/messages.html' %}

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% else %}

<!-- Class Selector -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <h3>{% trans "Select Class" %}</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
        {% for cls in classes %}
        <a href="?grade={{ cls.grade }}&section={{ cls.section }}{% if school %}&school_id={{ school.pk }}{% endif %}"
            class="btn {% if cls.name == selected_class.name %}btn-primary{% else %}btn-outline{% endif %}">
            {{ cls.name }}
        </a>
        {% empty %}
        <p class="text-muted">{% trans "No classes found. Please upload master student list." %}</p>
        {% endfor %}
    </div>
</div>

{% if stats %}
<!-- Class Statistics Cards -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
    <div class="card" style="text-align: center;">
        <div class="text-muted">{% trans "Students in Class" %}</div>
        <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">
            {{ stats.total_students }}
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <div class="text-muted">{% trans "Total Exams Taken" %}</div>
        <div style="font-size: 2.5em; font-weight: bold; color: var(--primary);">
            {{ stats.total_exams }}
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <div class="text-muted">{% trans "Average Score" %}</div>
        <div
            style="font-size: 2.5em; font-weight: bold; color: {% if stats.avg_score >= 60 %}var(--success){% else %}var(--danger){% endif %};">
            {{ stats.avg_score }}%
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <div class="text-muted">{% trans "Pass Rate" %}</div>
        <div
            style="font-size: 2.5em; font-weight: bold; color: {% if stats.pass_rate >= 70 %}var(--success){% else %}var(--warning){% endif %};">
            {{ stats.pass_rate }}%
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <div class="text-muted">{% trans "Best Score" %}</div>
        <div style="font-size: 2.5em; font-weight: bold; color: var(--success);">
            {{ stats.max_score }}%
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <div class="text-muted">{% trans "Lowest Score" %}</div>
        <div style="font-size: 2.5em; font-weight: bold; color: var(--danger);">
            {{ stats.min_score }}%
        </div>
    </div>
</div>

<!-- Charts & Tables Row -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
    <!-- Class Comparison Chart -->
    <div class="card">
        <h3>{% trans "Class Comparison (Average Scores)" %}</h3>
        <canvas id="comparisonChart" height="200"></canvas>
    </div>

    <!-- Top Students -->
    <div class="card">
        <h3>{% trans "Top Performers" %} - {{ selected_class.name }}</h3>
        {% if stats.top_students %}
        <div class="table-container">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>{% trans "Student" %}</th>
                        <th>{% trans "Avg Score" %}</th>
                        <th>{% trans "Exams" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in stats.top_students %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ student.student__first_name }} {{ student.student__last_name }}</td>
                        <td>
                            <span
                                class="badge {% if student.avg_score >= 60 %}badge-success{% else %}badge-danger{% endif %}">
                                {{ student.avg_score|floatformat:1 }}%
                            </span>
                        </td>
                        <td>{{ student.exams_taken }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center" style="padding: 20px;">{% trans "No exam data available for this class." %}
        </p>
        {% endif %}
    </div>
</div>

{% endif %}

{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if chart_labels and chart_data %}
<script>
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ chart_labels| safe }},
        datasets: [{
            label: '{% trans "Average Score (%)" %}',
            data: {{ chart_data| safe }},
        backgroundColor: 'rgba(79, 70, 229, 0.7)',
        borderColor: 'rgba(79, 70, 229, 1)',
        borderWidth: 1
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
    });
</script>
{% endif %}
{% endblock %}