{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Advanced Analytics" %} - {{ student.full_name }}{% endblock %}

{% block content %}
<div class="topbar">
    <div class="topbar-left">
        <h1 class="topbar-title">{% trans "Advanced Analytics" %}: {{ student.full_name }}</h1>
        <div style="margin-left: 20px; display: flex; gap: 4px;">
            <a href="?source=exams"
                class="btn btn-sm {% if source == 'exams' %}btn-primary{% else %}btn-outline{% endif %}">
                {% trans "Exams" %}
            </a>
            <a href="?source=zipgrade"
                class="btn btn-sm {% if source == 'zipgrade' %}btn-primary{% else %}btn-outline{% endif %}">
                {% trans "ZipGrade" %}
            </a>
        </div>
    </div>
    <div class="topbar-actions">
        <a href="{% url 'analytics:students' %}?student_id={{ student.pk }}&source={{ source }}"
            class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            {% trans "Back" %}
        </a>
    </div>
</div>

{% include 'partials/messages.html' %}

<!-- Exam Selector -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <form method="get" style="display: flex; flex-wrap: wrap; gap: var(--spacing-md); align-items: flex-end;">
        <input type="hidden" name="source" value="{{ source }}">
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 300px;">
            <label class="form-label">{% trans "Select Exams for Analysis" %}</label>
            <select name="exam_ids" multiple class="form-select" style="min-height: 100px;">
                {% for exam in available_exams %}
                <option value="{{ exam.pk }}" {% if exam.pk|stringformat:"s" in selected_exam_ids %}selected{% endif %}>
                    {{ exam.title }} ({% if source == 'zipgrade' %}{{ exam.exam_date }}{% else %}{{
                    exam.created_at|date:"Y-m-d" }}{% endif %})</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">{% trans "Apply" %}</button>
    </form>
</div>

<!-- Weakest Areas Alert -->
{% if weakest_areas %}
<div class="card" style="margin-bottom: var(--spacing-lg); border-left: 4px solid var(--warning);">
    <h3 style="color: var(--warning);"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
            <line x1="12" y1="9" x2="12" y2="13" />
            <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>{% trans "Areas Needing Attention" %}</h3>
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-md);">
        {% for area in weakest_areas %}
        <div style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: 8px;">
            <div style="font-weight: 600;">{{ area.subject }}</div>
            <div style="font-size: 2em; color: var(--danger);">{{ area.percentage }}%</div>
            <div class="text-muted" style="font-size: 0.85em;">{{ area.recommendation }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
    <!-- Radar Chart -->
    <div class="card">
        <h3>
            {% trans "Subject Mastery" %}
            <span class="text-muted" style="font-size: 0.7em;">
                ({% trans "vs Class Average" %})
            </span>
        </h3>
        <canvas id="radarChart" height="300"></canvas>
    </div>

    <!-- Competency Gap -->
    <div class="card">
        <h3>{% trans "Competency Gap Analysis" %}</h3>
        <canvas id="gapChart" height="300"></canvas>
    </div>
</div>

<!-- Trend Line -->
<div class="card" style="margin-bottom: var(--spacing-xl);">
    <h3>
        {% trans "Performance Trend" %}
        <span class="text-muted" style="font-size: 0.7em;">
            ({% trans "with Moving Average" %})
        </span>
    </h3>
    <canvas id="trendChart" height="150"></canvas>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const radarData = {{ radar_data| safe }};
    const trendData = {{ trend_data| safe }};
    const gapData = {{ gap_data| safe }};

    // Radar Chart
    if (radarData.length > 0) {
        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: radarData.map(d => d.subject),
                datasets: [
                    {
                        label: '{% trans "Student Score" %}',
                        data: radarData.map(d => d.score),
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderColor: '#4f46e5',
                        pointBackgroundColor: '#4f46e5',
                    },
                    {
                        label: '{% trans "Class Average" %}',
                        data: radarData.map(d => d.classAvg),
                        backgroundColor: 'rgba(156, 163, 175, 0.2)',
                        borderColor: '#9ca3af',
                        pointBackgroundColor: '#9ca3af',
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { stepSize: 20 }
                    }
                }
            }
        });
    }

    // Trend Chart
    if (trendData.scores && trendData.scores.length > 0) {
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: [
                    {
                        label: '{% trans "Score" %}',
                        data: trendData.scores,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: '{% trans "Moving Average" %}',
                        data: trendData.movingAverage,
                        borderColor: '#ef4444',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.dataset.label + ': ' + (ctx.raw !== null ? ctx.raw + '%' : 'N/A')
                        }
                    }
                }
            }
        });
    }

    // Gap Chart
    if (gapData.length > 0) {
        const gapCtx = document.getElementById('gapChart').getContext('2d');
        new Chart(gapCtx, {
            type: 'bar',
            data: {
                labels: gapData.map(d => d.subject),
                datasets: [
                    {
                        label: '{% trans "Gap vs Class Avg" %}',
                        data: gapData.map(d => d.gap),
                        backgroundColor: gapData.map(d => d.gap >= 0 ? '#10b981' : '#ef4444'),
                        borderRadius: 4
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        ticks: { callback: v => (v >= 0 ? '+' : '') + v + '%' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => (ctx.raw >= 0 ? '+' : '') + ctx.raw + '% {% trans "vs class average" %}'
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}