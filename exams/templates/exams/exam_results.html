{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Exam Results" %} - {{ exam.title }}{% endblock %}

{% block content %}
<div class="topbar">
    <div class="topbar-left">
        <a href="{% url 'exams:exam_list' %}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            {% trans "Back to Exams" %}
        </a>
        <h1 class="topbar-title">{% trans "Results" %}: {{ exam.title }}</h1>
    </div>
</div>

{% include 'partials/messages.html' %}

<div class="card" style="margin-bottom: var(--spacing-lg);">
    <form method="get" class="filter-form">
        <div class="filter-row" style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; align-items: center;">
            <div class="filter-group">
                <input type="text" name="search" class="form-input" placeholder="{% trans 'Search by name or email...' %}" value="{{ search }}" style="min-width: 250px;">
            </div>
            <div class="filter-group">
                <select name="status" class="form-select">
                    <option value="">{% trans "All Status" %}</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
                    <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>{% trans "In Progress" %}</option>
                    <option value="locked" {% if status == 'locked' %}selected{% endif %}>{% trans "Locked" %}</option>
                </select>
            </div>
            <div class="filter-group">
                <select name="sort" class="form-select">
                    <option value="">{% trans "Sort by Date" %}</option>
                    <option value="score_high" {% if sort == 'score_high' %}selected{% endif %}>{% trans "Score: High to Low" %}</option>
                    <option value="score_low" {% if sort == 'score_low' %}selected{% endif %}>{% trans "Score: Low to High" %}</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">{% trans "Filter" %}</button>
            {% if search or status or sort %}
            <a href="{% url 'exams:exam_results' exam.pk %}" class="btn btn-outline">{% trans "Clear" %}</a>
            {% endif %}
            <div class="filter-group" style="flex: 1; text-align: right;">
                <span class="badge badge-primary">{% trans "Total" %}: {{ attempts.count }}</span>
            </div>
        </div>
    </form>
</div>

<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>{% trans "Student" %}</th>
                    <th>{% trans "Started" %}</th>
                    <th>{% trans "Finished" %}</th>
                    <th>{% trans "Score" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in attempts %}
                <tr>
                    <td>
                        <a href="{% url 'exams:view_attempt_answers' attempt.pk %}" style="text-decoration: none;">
                            <strong style="color: var(--primary);">{{ attempt.student.get_full_name }}</strong>
                        </a>
                        <div class="text-muted small">{{ attempt.student.email }}</div>
                    </td>
                    <td>{{ attempt.started_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ attempt.finished_at|date:"d.m.Y H:i"|default:"-" }}</td>
                    <td>
                        {% if attempt.score is not None %}
                        <span class="{% if attempt.is_passed %}text-success{% else %}text-danger{% endif %} font-bold">{{ attempt.percentage }}%</span>
                        <span class="text-muted small">({{ attempt.score }}/{{ exam.total_points }})</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if attempt.is_locked %}
                        <span class="badge badge-danger">{% trans "Locked" %}</span>
                        <div class="text-danger small" style="margin-top: 4px;">{{ attempt.lock_reason }} ({{ attempt.tab_switch_count }} taps)</div>
                        {% elif attempt.status == 'completed' %}
                        <span class="badge badge-success">{% trans "Completed" %}</span>
                        {% elif attempt.status == 'in_progress' %}
                        <span class="badge badge-warning">{% trans "In Progress" %}</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ attempt.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'exams:view_attempt_answers' attempt.pk %}" class="btn btn-sm btn-outline">{% trans "View" %}</a>
                        {% if attempt.is_locked %}
                        <a href="{% url 'exams:unlock_attempt' attempt.pk %}" class="btn btn-sm btn-warning">{% trans "Unlock" %}</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">{% trans "No attempts found." %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
