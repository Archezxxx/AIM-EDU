{% extends 'base.html' %}
{% load i18n exam_extras %}

{% block title %}{{ exam.title }} - {% trans "InProgress" %}{% endblock %}

{% block content %}
<style>
    /* Prevent text selection and copy */
    body {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
    }

    .exam-timer {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--surface);
        padding: 10px 20px;
        border-radius: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        font-weight: bold;
        z-index: 1000;
        border: 2px solid var(--primary);
    }

    .timer-warning {
        color: var(--danger);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    .question-nav {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }

    .nav-btn {
        width: 100%;
        padding: 8px;
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        background: var(--surface);
    }

    .nav-btn.answered {
        background-color: var(--primary-light);
        border-color: var(--primary);
        color: var(--primary);
    }

    .nav-btn.current {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    #warning-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .warning-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        max-width: 500px;
    }
</style>

<div id="warning-modal">
    <div class="warning-content">
        <h2 style="color: var(--danger);">{% trans "⚠️ Warning!" %}</h2>
        <p style="font-size: 1.2em; margin: 20px 0;">
            {% trans "Tab switching is prohibited!" %}
        </p>
        <p>{% trans "You have" %} <strong id="strike-count">0</strong>/{{ exam.max_tab_switches }} {% trans "strikes."
            %}</p>
        <p>{% trans "If you reach the limit, your exam will be locked." %}</p>
        <button class="btn btn-primary" onclick="closeWarning()">{% trans "I Understand" %}</button>
    </div>
</div>

<div class="exam-timer" id="timer-display">
    --:--:--
</div>

<div class="topbar">
    <h1 class="topbar-title">{{ exam.title }}</h1>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3>{% trans "Question Navigation" %}</h3>
    <div class="question-nav">
        {% for q in questions %}
        <a href="#q-{{ q.pk }}" class="nav-btn {% if q.pk in existing_answers %}answered{% endif %}"
            id="nav-{{ q.pk }}">
            {{ forloop.counter }}
        </a>
        {% endfor %}
    </div>
</div>

<form method="post" action="{% url 'exams:submit_exam' attempt.pk %}" id="exam-form">
    {% csrf_token %}

    {% for q in questions %}
    <div class="card" id="q-{{ q.pk }}" style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span class="badge badge-secondary">{% trans "Question" %} {{ forloop.counter }}</span>
            <span class="badge badge-outline">{{ q.points }} {% trans "pts" %}</span>
        </div>

        <h3 style="margin-bottom: 20px;">{{ q.question_text|linebreaksbr }}</h3>

        {% if q.question_image %}
        <div style="margin-bottom: 20px;">
            <img src="{{ q.question_image.url }}" style="max-width: 100%; max-height: 400px; border-radius: 8px;">
        </div>
        {% endif %}

        {% if q.question_type == 'fill_blanks' %}
        <div class="fill-blanks-group">
            <label class="form-label">{% trans "Your Answer:" %}</label>
            <input type="text" name="question_{{ q.pk }}_text" id="answer-{{ q.pk }}" class="form-input"
                value="{{ existing_text_answers|get_item:q.pk|default:'' }}"
                placeholder="{% trans 'Type your answer here...' %}" onchange="saveTextAnswer({{ q.pk }}, this.value)"
                style="max-width: 500px;">
        </div>
        {% else %}
        <div class="options-group">
            {% for option in q.options.all %}
            <div class="option-item" style="margin-bottom: 10px;">
                <label
                    style="display: flex; gap: 10px; align-items: start; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: 0.2s;">
                    <input type="radio" name="question_{{ q.pk }}" value="{{ option.pk }}"
                        onchange="saveAnswer({{ q.pk }}, {{ option.pk }})" {% if existing_answers|get_item:q.pk == option.pk %}checked{% endif %} style="margin-top: 4px;">
                    <span>{{ option.text }}</span>
                </label>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endfor %}

    <div class="card" style="text-align: center; padding: 40px;">
        <h3>{% trans "Exam Completed?" %}</h3>
        <p>{% trans "Review your answers before submitting." %}</p>
        <button type="button" class="btn btn-primary" onclick="confirmSubmit()">
            {% trans "Submit Exam" %}
        </button>
    </div>
</form>

<script>
    // Config
    const ATTEMPT_ID = {{ attempt.pk }};
    const MAX_STRIKES = {{ exam.max_tab_switches }};
    let timeRemaining = {{ time_remaining }};
    let strikes = {{ attempt.tab_switch_count }};

    // Timer Logic
    const timerDisplay = document.getElementById('timer-display');
    const timerInterval = setInterval(() => {
        timeRemaining--;

        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            document.getElementById('exam-form').submit();
        }

        const h = Math.floor(timeRemaining / 3600);
        const m = Math.floor((timeRemaining % 3600) / 60);
        const s = timeRemaining % 60;

        timerDisplay.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

        if (timeRemaining < 300) { // 5 mins left
            timerDisplay.classList.add('timer-warning');
        }
    }, 1000);

    // Save Answer Logic
    function saveAnswer(questionId, optionId) {
        fetch(`{% url 'exams:save_answer' attempt.pk %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question_id: questionId,
                option_id: optionId
            })
        }).then(response => {
            if (response.ok) {
                document.getElementById(`nav-${questionId}`).classList.add('answered');
            }
        });
    }

    // Save Text Answer Logic (for fill_blanks)
    function saveTextAnswer(questionId, textAnswer) {
        fetch(`{% url 'exams:save_answer' attempt.pk %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question_id: questionId,
                text_answer: textAnswer
            })
        }).then(response => {
            if (response.ok) {
                document.getElementById(`nav-${questionId}`).classList.add('answered');
            }
        });
    }

    // Proctoring Logic (3-Strike Rule)
    function logEvent(type, details = {}) {
        fetch(`{% url 'exams:log_proctor_event' attempt.pk %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                event_type: type,
                details: details
            })
        }).then(res => res.json())
            .then(data => {
                if (data.locked) {
                    window.location.reload();
                }
                if (data.tab_count ! ==  undefined) {
                    strikes = data.tab_count;
                    document.getElementById('strike-count').textContent = strikes;
                    showWarning();
                }
            });
    }

    // Visibility Change API (Tab switching)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            logEvent('tab_switch');
        }
    });

    // Window Blur (Detects clicking outside browser)
    window.addEventListener('blur', () => {
        // Optional: Can be too sensitive, leaving disabled for now or enable strict mode
        // logEvent('window_blur');
    });

    // Prevent Context Menu (Right Click)
    document.addEventListener('contextmenu', event => {
        event.preventDefault();
        logEvent('right_click');
    });

    // UI Helpers
    function showWarning() {
        document.getElementById('warning-modal').style.display = 'flex';
    }

    function closeWarning() {
        document.getElementById('warning-modal').style.display = 'none';
    }

    function confirmSubmit() {
        if (confirm("{% trans 'Are you sure you want to submit? This action cannot be undone.' %}")) {
            document.getElementById('exam-form').submit();
        }
    }
</script>
{% endblock %}